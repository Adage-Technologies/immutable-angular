!function(e,t){"function"==typeof define&&define.amd?define(["angular","immutable"],t):"undefined"!=typeof exports?t(require("angular"),require("immutable")):t(e.angular,e.Immutable)}(this,function(e,t){"use strict";var r=e.module("immutable-angular",[]);r.directive("repeatImmutable",function(){function r(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function n(t){if(!e.isUndefined(t.$$repeatImmutableKey))return t.$$repeatImmutableKey;var n="$$repeatImmutable:object:"+r()+r()+"-"+r()+"-"+r()+"-"+r()+"-"+r()+r()+r();return Object.defineProperty(t,"$$repeatImmutableKey",{value:n}),n}function i(e){return"$$repeatImmutable:primitive"+e}function a(t){return!e.isObject(t)&&!e.isArray(t)}function o(e){return a(e)?i(e):n(e)}var u=/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)$/;return{restrict:"A",transclude:"element",priority:100,compile:function(e,r){var n=r.repeatImmutable,i=n.match(u);if(!i)throw new Error('expression must be of the form "item in collection"');var a=i[1],c=i[2];return function(e,r,n,i,u){function m(e){var t=s.get(e);t.scope().$destroy(),t.remove(),s=s["delete"](e)}var s=t.Map(),f=t.Set();e.$watchImmutable(c,function(e){if(e&&!t.List.isList(e)&&!e.toList)throw new Error("repeatImmutable: iterated item must be an instance of an Immutable collection");var n=e?t.List.isList(e)?e:e.toList():t.List(),i=r;f=f.clear(),n.forEach(function(e,t){var r=o(e);if(f.has(r))throw new Error("Duplicate items are not currently allowed in repeatImmutable");if(f=f.add(r),s.has(r)&&m(r),0!==t){var c=n.get(t-1),l=o(c);s.has(l)&&(i=s.get(l))}u(function(t,n){s=s.set(r,t),n[a]=e,i.after(t),i=t})}),s.forEach(function(e,t){f.has(t)||m(t)})})}}}}),r.config(["$provide",function(e){e.decorator("$rootScope",["$delegate","$parse",function(e,r){var n={};return e.constructor.prototype.$watchImmutable=function(e,i){var a=this,o=r(e),u=n;this.$watch(function(){var e=o(a);return t.is(e,u)||(u=e),u},i)},e}])}])});